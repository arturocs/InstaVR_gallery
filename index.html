<!DOCTYPE html>
<html>

<head>
	<meta charot_supet="utf-8">
	<title>Insta VR</title>
	<script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
	<script src="https://unpkg.com/aframe-look-at-component@0.7.0/dist/aframe-look-at-component.min.js"></script>
	<script src="https://unpkg.com/aframe-animation-component@^5.1.2/dist/aframe-animation-component.min.js"></script>
</head>

<body>
	<a-scene id="scene">
		<a-assets id="assets">
			<img id="sky" src="./sky.jpg">
		</a-assets>
		<a-light type="ambient" color="white"></a-light>
		<a-entity id="anillo-superior" animation="property:rotation; pauseEvents: rotation-pause; resumeEvents: rotation-resume; to:0 360 0; easing:linear; dir:alternate; dur:120000; loop:true">
			<a-image id="im0" position="0 1 -1.5" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
			<a-image id="im1" position="-1.299 1 -0.75" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
			<a-image id="im2" position="-1.299 1 0.75" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
			<a-image id="im3" position="0 1 1.5" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
			<a-image id="im4" position="1.299 1 -0.75" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
			<a-image id="im5" position="1.299 1 0.75" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
		</a-entity>
		<a-entity id="anillo-inferior" animation="property:rotation; pauseEvents: rotation-pause; resumeEvents: rotation-resume; to:0 -360 0; easing:linear; dir:alternate; dur:120000; loop:true">
			<a-image id="im6" position="0 2.2 -1.5" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
			<a-image id="im7" position="-1.299 2.2 -0.75" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
			<a-image id="im8" position="-1.299 2.2 0.75" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
			<a-image id="im9" position="0 2.2 1.5" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
			<a-image id="im10" position="1.299 2.2 -0.75" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
			<a-image id="im11" position="1.299 2.2 0.75" src="" visible="false" look-at="#camera">
				<a-plane color="#d3d3d3" height="1.13" width="1.13" position="0 0 -0.1"></a-plane>
			</a-image>
		</a-entity>
		<a-camera id="camera" wasd-controls-enabled="false" look-controls>
			<a-text id="texto" value="Cargando" position="-0.6 0 -2" width="6" visible="true"></a-text>
		</a-camera>
		<a-sky id="skybox" color="black" src="#sky"></a-sky>
	</a-scene>
</body>

<script>
	var txt = document.querySelector("#texto")
	var scene = document.querySelector('#scene');
	var anillo_inf = document.querySelector("#anillo-inferior");
	var anillo_sup = document.querySelector("#anillo-superior");
	var currentEvent = 'rotation-pause'
	var fotemp, im, url, rot_sup, rot_inf, touchCount = 0,
		fotos, fotos_trim = []
	var usuario = window.location.href.split('?')[1]

	function anim_control() {
		anillo_sup.dispatchEvent(new CustomEvent(currentEvent))
		anillo_inf.dispatchEvent(new CustomEvent(currentEvent))
		switch (currentEvent) {
			case 'rotation-resume':
				currentEvent = 'rotation-pause'
				break
			case 'rotation-pause':
				currentEvent = 'rotation-resume'
				break
		}
	}

	if (usuario !== undefined) {
		url = 'https://www.instagram.com/' + usuario + '?__a=1'
		const Http = new XMLHttpRequest();
		Http.open("GET", url);
		Http.send();
		Http.onreadystatechange = function () {
			if (this.readyState == 4 && (this.status == 200 || this.status == 404)) {
				if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
					scene.addEventListener('touchend', anim_control);
				} else {
					scene.addEventListener('dblclick', anim_control);
				}

				document.getElementById('anillo-inferior').addEventListener('pause', function () {
					document.querySelector('a-animation').setAttribute('from', AFRAME.utils.coordinates.stringify(this.getAttribute(
						'rotation')))
				})
				console.log(Http)
				fotos = Http.responseText.match(/"thumbnail_src":"[^"]*"/g)
				if (fotos !== null) {
					fotos.forEach(function (foto) {
						fotemp = foto.split(':\"')[1]
						fotos_trim.push(fotemp.substring(0, fotemp.length - 1))
					})
					for (var i = 0; i < fotos_trim.length; i++) {
						im = document.querySelector("#im" + i)
						im.setAttribute("src", fotos_trim[i])
						im.setAttribute("visible", "true")
						im.removeAttribute('look-at')
					}
					document.querySelector("#skybox").setAttribute("color", "white")
					txt.setAttribute("visible", "false")
				} else {
					txt.setAttribute("position", "-0.2 0 -2")
					txt.setAttribute("value", "Error")
				}
			}
		}
	} else {
		txt.setAttribute("position", "-0.2 0 -2")
		txt.setAttribute("value", "Error")
		console.log("Usuario sin definir")
	}
</script>

</html>